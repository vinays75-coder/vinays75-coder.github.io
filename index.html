<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title></title>


    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">


    <style>
        .file-dragdrop {
            margin: 0;
            padding: 0;
            width: 100%;
            background-color: #f3f8f9;
            border: 1px dashed #9e9e9e;
            min-height: 150px;
            padding: 40px 20px;
            border-radius: 5px;
            position: relative;
            z-index: 1;
        }
    </style>

</head>

<body>
    <div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
        <h5 class="my-0 mr-md-auto font-weight-normal">Welcome - Ship it!!</h5>
        <nav class="my-2 my-md-0 mr-md-3">
        </nav>
    </div>

    <div class="p-2 mx-auto text-center">
        <h2 class="">Let's see if we can upload some data</h2>
        <p class="lead">Go fast, don't break anything</p>
    </div>

    <div class="container">
        <div class="card-deck mb-3 text-center">
            <div class="card mb-2 shadow">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Step 1 : Token</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <form>
                                <div class="form-row px-3">
                                  <label class="px-2" for="exampleFormControlSelect1">Select Environment</label>
                                  <select class="form-control" id="environment">
                                      <option value="RSI-dev">https://RSI-Dev</option>
                                    <option value="dev">https://dev-smbp.amaaws.org</option>
                                    <option value="test">https://test-smbp.amaaws.org</option>
                                    <option value="stage">https://smbp-stage.verifi.health</option>
                                  </select>
                                </div>
                            </form>
                        </div>
                        <div class="col-6">
                            <form>
                                <div class="form-row px-3">
                                    <label class="px-2" for="exampleFormControlSelect1">Username <span class="text-muted font-italic">(must have the standard password)</span></label>
                                    <input type="text" class="form-control" id="username" value="wayne.do@ama-assn.org" required>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col pt-3">
                        <button type="button" class="btn btn-md btn-primary" onclick="getAccessToken()">Get Access
                            Token</button>
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-deck mb-3 text-center">
            <div class="card mb-2 shadow">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Step 2 : Data file</h4>
                </div>
                <div class="card-body">
                    <div class="">
                        <div id="droparea" class="file-dragdrop py-3 mb-3">
                            <div>
                                <h3 id="filenameId">Drag a file here</h3>
                                <p>or</p>

                                <form>
                                    <div class="px-5">
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="dataFile">
                                            <label id="fileLabel" class="custom-file-label" for="customFile">Choose
                                                file</label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="pt-4">
                                <p> CSV File Format: <b>patientid, date, sbp, dbp, hr</b></p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 d-none">
                            <button type="button" class="btn btn-md btn-primary" onclick="processDataFhir()">Process
                                Data FHIR</button>
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-md btn-primary" onclick="processDataAnD()">Process Data
                                A&D</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="card-deck mb-3 text-center">
            <div class="card mb-2 shadow">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Step 3 : Store Readings</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 d-none">
                            <button type="button" class="btn btn-md btn-primary" onclick="storeReadingsFhir()">Store
                                Readings FHIR</button>
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-md btn-primary" onclick="storeReadingsAnD()">Store
                                Readings A&D</button>
                        </div>
                    </div>
                    <div class="p-3">
                        <div class="py-3" id="datapanelid"></div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="pt-4 my-md-5 pt-md-5 border-top">
            <div class="row">
            </div>
        </footer>
    </div>

    <script>
        let dataFile;
        const dropArea = document.getElementById('droparea');

        dropArea.addEventListener('dragover', (event) => {
            event.stopPropagation();
            event.preventDefault();
            // Style the drag-and-drop as a "copy file" operation.
            event.dataTransfer.dropEffect = 'copy';
        });

        dropArea.addEventListener('drop', (event) => {
            event.stopPropagation();
            event.preventDefault();
            const fileList = event.dataTransfer.files;

            document.getElementById("fileLabel").innerHTML = fileList[0].name;
            document.getElementById("filenameId").innerHTML = fileList[0].name;
            dataFile = fileList[0];
            console.log(dataFile);
        });


        // Add the following code if you want the name of the file appear on select
        document.getElementById("dataFile").addEventListener('change', (event) => {
            const fileList = event.target.files;
            document.getElementById("fileLabel").innerHTML = fileList[0].name;;
            document.getElementById("filenameId").innerHTML = fileList[0].name;
            dataFile = fileList[0];
            console.log(dataFile)
        });

    </script>

    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js" type="text/javascript"></script>
    <script>

        /************** SET SOME ENV VARIABLES ******************/
        const envs = {
             "RSI-dev" : {
                "getTokenUrl" : "http://203.34.117.174:8081/smart-is/identity/generate-token",
                "storeReadingsFhirUrl" : "http://203.34.117.174:8081/smart-device-connect/mmhg/v1/store/readings",
                "storeReadingsAnDUrl" : "http://203.34.117.174:8081/smart-device-connect/ADDevice/v1/store/readings"
            },
            "dev" : {
                "getTokenUrl" : "https://dev-smbp.amaaws.org/smart-is/identity/generate-token",
                "storeReadingsFhirUrl" : "https://dev-smbp.amaaws.org/smart-device-connect/mmhg/v1/store/readings",
                "storeReadingsAnDUrl" : "https://dev-smbp.amaaws.org/smart-device-connect/ADDevice/v1/store/readings"
            },
            "test" : {
                "getTokenUrl" : "https://test-smbp.amaaws.org/smart-is/identity/generate-token",
                "storeReadingsFhirUrl" : "https://test-smbp.amaaws.org/smart-device-connect/mmhg/v1/store/readings",
                "storeReadingsAnDUrl" : "https://test-smbp.amaaws.org/smart-device-connect/ADDevice/v1/store/readings"
            },
            "stage" : {
                "getTokenUrl" : "https://smbp-stage.verifi.health/smart-is/identity/generate-token",
                "storeReadingsFhirUrl" : "https://smbp-stage.verifi.health/smart-device-connect/mmhg/v1/store/readings",
                "storeReadingsAnDUrl" : "https://smbp-stage.verifi.health/smart-device-connect/ADDevice/v1/store/readings"
            }
        };
        /*** dev or test  ***/
        let env = envs["dev"];
        // let env = envs["test"];

        /************** SET SOME ENV VARIABLES - END  ******************/



        /************** GET TOKEN ******************/
        // data to be sent to the POST request
        let tokendata = {
            "grant_type": "password",
            "username": "wayne.do@ama-assn.org",
            "password": "05NAuSTa24nCm4On4NgLvA=="
        };
        let token = null;

        function getAccessToken() {
            env = envs[document.getElementById("environment").value];
            tokendata.username = document.getElementById("username").value;
            console.log(env.getTokenUrl + '  ' + tokendata.username)

            fetch(env.getTokenUrl, {
                method: 'post',
                headers: {
                    "Content-type": "application/json"
                },
                body: JSON.stringify(tokendata),
            })
                .then(
                    function (response) {
                        if (response.status !== 200) {
                            console.log('Status Code: ' + response.status);
                            return;
                        }
                        response.json().then(function (data) {
                            console.log(data);
                            access_token = data.access_token;
                            console.log(data.access_token)
                        });
                    }
                )
                .catch(function (err) {
                    console.log(err);
                });
        }

        /************** GET TOKEN - END  ******************/


        /************** SUBMIT DATA - FHIR ******************/
        // data to be sent to the POST request
        let obsData = null;

        let bpData = [{
            "patient": "Patient/1006",
            "resourceId": "88335",
            "date": "2020-10-17T12:00:00-04:00",
            "sbp": "135",
            "dbp": "88",
            "hr": "81"
        }, {
            "patient": "Patient/1006",
            "resourceId": "88336",
            "date": "2020-10-17T12:05:00-04:00",
            "sbp": "137",
            "dbp": "89",
            "hr": "80"
        }, {
            "patient": "Patient/1006",
            "resourceId": "88337",
            "date": "2020-10-17T22:00:00-04:00",
            "sbp": "136",
            "dbp": "90",
            "hr": "80"
        }, {
            "patient": "Patient/1006",
            "resourceId": "88338",
            "date": "2020-10-17T22:05:00-04:00",
            "sbp": "138",
            "dbp": "91",
            "hr": "83"
        }];

        function processDataFhir() {
            let readings;
            obsData = JSON.parse(JSON.stringify(sampleReadingFhir));

            Papa.parse(dataFile, {
                header: true,
                complete: function (results) {
                    console.log(results);
                    readings = results.data;

                    let bpResource = JSON.parse(JSON.stringify(obsData.entry[0]));
                    let hrResource = JSON.parse(JSON.stringify(obsData.entry[1]));

                    let newEntry = [];
                    readings.forEach(function (item, index, array) {
                        let bpResource = JSON.parse(JSON.stringify(obsData.entry[0]));
                        let hrResource = JSON.parse(JSON.stringify(obsData.entry[1]));

                        bpResource.resource.id = item.resourceId;
                        bpResource.resource.subject.reference = 'Patient/' + item.patientid;
                        bpResource.resource.effectiveDateTime = item.date;
                        bpResource.resource.component[0].valueQuantity.value = item.sbp;
                        bpResource.resource.component[1].valueQuantity.value = item.dbp;

                        hrResource.resource.id = item.resourceId + 1;
                        hrResource.resource.subject.reference = 'Patient/' + item.patientid;
                        hrResource.resource.effectiveDateTime = item.date;
                        hrResource.resource.valueQuantity.value = item.hr;

                        newEntry.push(bpResource);
                        newEntry.push(hrResource);

                    });

                    obsData.entry = newEntry;
                    document.getElementById("datapanelid").innerHTML = JSON.stringify(readings);
                }
            });

        }

        function storeReadingsFhir() {
            console.log(obsData)

            fetch(env.storeReadingsFhirUrl, {
                method: 'post',
                headers: {
                    "Content-type": "application/json",
                    "Authorization": "Bearer " + access_token
                },
                body: JSON.stringify(obsData),
            })
                .then(
                    function (response) {
                        if (response.status !== 200) {
                            console.log('Status Code: ' + response.status);
                            return;
                        }
                        response.json().then(function (data) {
                            console.log(data);
                        });
                    }
                )
                .catch(function (err) {
                    console.log(err);
                });
        }

        let sampleReadingFhir = {
            "resourceType": "Bundle",
            "type": "collection",
            "entry": [
                {
                    "resource": {
                        "resourceType": "Observation",
                        "id": "88324",
                        "meta": {
                            "versionId": "1",
                            "lastUpdated": "2020-10-13T15:49:53.517+05:30",
                            "profile": [
                                "http://hl7.org/fhir/StructureDefinition/bp"
                            ]
                        },
                        "contained": [
                            {
                                "resourceType": "Device",
                                "id": "1",
                                "type": {
                                    "coding": [
                                        {
                                            "system": "http://snomed.info/sct",
                                            "code": "3931000207106",
                                            "display": "Automatic blood pressure monitor with medium adult cuff (physical object)"
                                        }
                                    ]
                                },
                                "manufacturer": "Omron Healthcare, Inc.",
                                "model": "BP765CAN-CD6"
                            }
                        ],
                        "extension": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/observation-bodyPosition",
                                "valueCodeableConcept": {
                                    "coding": [
                                        {
                                            "system": "http://snomed.info/sct",
                                            "code": "33586001",
                                            "display": "Sitting position (finding)"
                                        }
                                    ]
                                }
                            },
                            {
                                "url": "http://www.ama-ihmi.org/fhir/StructureDefinition/observation-exertionalStatus",
                                "valueCodeableConcept": {
                                    "coding": [
                                        {
                                            "system": "http://snomed.info/sct",
                                            "code": "128975004",
                                            "display": "Resting state (finding)"
                                        }
                                    ]
                                }
                            }
                        ],
                        "status": "final",
                        "category": [
                            {
                                "coding": [
                                    {
                                        "system": "http://hl7.org/fhir/observation-category",
                                        "code": "vital-signs",
                                        "display": "Vital Signs"
                                    }
                                ]
                            }
                        ],
                        "code": {
                            "coding": [
                                {
                                    "system": "http://loinc.org",
                                    "code": "85354-9",
                                    "display": "Blood pressure panel with all children optional"
                                },
                                {
                                    "system": "http://snomed.info/sct",
                                    "code": "4011000207100",
                                    "display": "Measurement of blood pressure (procedure)"
                                }
                            ]
                        },
                        "subject": {
                            "reference": "Patient/1006"
                        },
                        "effectiveDateTime": "2020-10-13T08:00:00-04:00",
                        "comment": "Need Care",
                        "bodySite": {
                            "coding": [
                                {
                                    "system": "http://snomed.info/sct",
                                    "code": "368208006",
                                    "display": "Left upper arm structure (body structure)"
                                }
                            ]
                        },
                        "device": {
                            "reference": "#1"
                        },
                        "component": [
                            {
                                "code": {
                                    "coding": [
                                        {
                                            "system": "http://loinc.org",
                                            "code": "8480-6",
                                            "display": "Systolic blood pressure"
                                        },
                                        {
                                            "system": "http://snomed.info/sct",
                                            "code": "4351000207102",
                                            "display": "Measurement of systolic blood pressure (procedure)"
                                        }
                                    ]
                                },
                                "valueQuantity": {
                                    "value": 129,
                                    "unit": "millimeter of mercury",
                                    "system": "http://unitsofmeasure.org",
                                    "code": "mm[Hg]"
                                }
                            },
                            {
                                "code": {
                                    "coding": [
                                        {
                                            "system": "http://loinc.org",
                                            "code": "8462-4",
                                            "display": "Diastolic blood pressure"
                                        },
                                        {
                                            "system": "http://snomed.info/sct",
                                            "code": "4131000207105",
                                            "display": "Measurement of diastolic blood pressure (procedure)"
                                        }
                                    ]
                                },
                                "valueQuantity": {
                                    "value": 84,
                                    "unit": "millimeter of mercury",
                                    "system": "http://unitsofmeasure.org",
                                    "code": "mm[Hg]"
                                }
                            }
                        ]
                    }
                },
                {
                    "resource": {
                        "resourceType": "Observation",
                        "id": "88324",
                        "meta": {
                            "versionId": "1",
                            "lastUpdated": "2020-10-13T15:49:53.517+05:30",
                            "profile": [
                                "http://hl7.org/fhir/StructureDefinition/heartrate"
                            ]
                        },
                        "contained": [
                            {
                                "resourceType": "Device",
                                "id": "1",
                                "type": {
                                    "coding": [
                                        {
                                            "system": "http://snomed.info/sct",
                                            "code": "3931000207106",
                                            "display": "Automatic blood pressure monitor with medium adult cuff (physical object)"
                                        }
                                    ]
                                },
                                "manufacturer": "Omron Healthcare, Inc.",
                                "model": "BP765CAN-CD6"
                            }
                        ],
                        "extension": [
                            {
                                "url": "http://hl7.org/fhir/StructureDefinition/observation-bodyPosition",
                                "valueCodeableConcept": {
                                    "coding": [
                                        {
                                            "system": "http://snomed.info/sct",
                                            "code": "33586001",
                                            "display": "Sitting position (finding)"
                                        }
                                    ]
                                }
                            },
                            {
                                "url": "http://www.ama-ihmi.org/fhir/StructureDefinition/observation-exertionalStatus",
                                "valueCodeableConcept": {
                                    "coding": [
                                        {
                                            "system": "http://snomed.info/sct",
                                            "code": "128975004",
                                            "display": "Resting state (finding)"
                                        }
                                    ]
                                }
                            }
                        ],
                        "status": "final",
                        "category": [
                            {
                                "coding": [
                                    {
                                        "system": "http://hl7.org/fhir/observation-category",
                                        "code": "vital-signs",
                                        "display": "Vital Signs"
                                    }
                                ]
                            }
                        ],
                        "code": {
                            "coding": [
                                {
                                    "system": "http://loinc.org",
                                    "code": "8867-4",
                                    "display": "Heart rate"
                                },
                                {
                                    "system": "http://snomed.info/sct",
                                    "code": "5271000207102",
                                    "display": "Measurement of heart rate (procedure)"
                                }
                            ]
                        },
                        "subject": {
                            "reference": "Patient/1006"
                        },
                        "effectiveDateTime": "2020-10-13T08:00:00-04:00",
                        "valueQuantity": {
                            "value": 80,
                            "unit": "per minute",
                            "system": "http://unitsofmeasure.org",
                            "code": "/min"
                        },
                        "comment": "Need Care",
                        "bodySite": {
                            "coding": [
                                {
                                    "system": "http://snomed.info/sct",
                                    "code": "368208006",
                                    "display": "Left upper arm structure (body structure)"
                                }
                            ]
                        },
                        "device": {
                            "reference": "#1"
                        }
                    }
                }
            ]
        };

        /************** A&D  ********************/
        function processDataAnD() {
            let readings;
            obsData = JSON.parse(JSON.stringify(sampleReadingAnD));

            Papa.parse(dataFile, {
                header: true,
                complete: function (results) {
                    console.log(results);
                    readingsData = results.data;

                    let newReadings = [];
                    readingsData.forEach(function (item, index, array) {
                        let reading = JSON.parse(JSON.stringify(obsData.payload.readings[0]));

                        obsData.payload.patient_id = item.patientid;
                        reading.reading_taken_time = (new Date(item.date)).getTime();
                        /*alert(item.date);
                        alert(item.date.length);
                        alert(item.date.lastIndexOf('-'));*/
                        reading.timezone_gmt_offset = item.date.substring(item.date.lastIndexOf('-'), item.date.length);
                        //alert(reading.timezone_gmt_offset);
                        reading.measurements[1].value = item.sbp;
                        reading.measurements[2].value = item.dbp;
                        reading.measurements[0].value = item.hr;

                        newReadings.push(reading);

                    });

                    obsData.payload.readings = newReadings;
                    document.getElementById("datapanelid").innerHTML = JSON.stringify(readingsData);
                    console.log(JSON.stringify(obsData));
                }
            });

        }

        function storeReadingsAnD() {
            console.log(obsData)

            fetch(env.storeReadingsAnDUrl, {
                method: 'post',
                headers: {
                    "Content-type": "application/json",
                    "Authorization": "Bearer " + access_token
                },
                body: JSON.stringify(obsData),
            })
                .then(
                    function (response) {
                        if (response.status !== 200) {
                            console.log('Status Code: ' + response.status);
                            return;
                        }
                        response.json().then(function (data) {
                            console.log(data);
                        });
                    }
                )
                .catch(function (err) {
                    console.log(err);
                });
        }


        let sampleReadingAnD = {
            "payload": {
                "operation": "CREATE",
                "patient_id": "1006",
                "readings": [
                    {
                        "reading_type": "bp",
                        "reading_taken_time": 1604266001968,
                        "timezone_gmt_offset": "-0700",
                        "accumulation": "none",
                        "app_platform": "android",
                        "app_build_version": "4.1.2",
                        "measurements": [
                            { "measurement_type": "pulse", "units": "bpm", "value": 89 },
                            { "measurement_type": "systolic", "units": "mmHg", "value": 149 },
                            { "measurement_type": "diastolic", "units": "mmHg", "value": 101 }]
                    }
                ]
            },
            "signature": {
                "public_key_url": "abcd",
                "signature": "abcd"
            }
        }

        /************** A&D - END ********************/

    </script>
</body>

</html>
